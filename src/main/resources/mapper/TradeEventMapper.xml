<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.trade.mapper.TradeEventMapper">

    <resultMap id="TradeEventMap" type="com.example.trade.domain.TradeEvent">
        <id property="tradeId" column="TRADE_ID"/>
        <result property="accountId" column="ACCOUNT_ID"/>
        <result property="instrumentId" column="INSTRUMENT_ID"/>
        <result property="eventType" column="EVENT_TYPE"/>
        <result property="quantity" column="QUANTITY"/>
        <result property="price" column="PRICE"/>
        <result property="amount" column="AMOUNT"/>
        <result property="currency" column="CURRENCY"/>
        <result property="status" column="STATUS"/>
        <result property="sourceSystem" column="SOURCE_SYSTEM"/>
        <result property="tradeDate" column="TRADE_DATE"/>
        <result property="createTime" column="CREATE_TIME"/>
        <result property="updateTime" column="UPDATE_TIME"/>
    </resultMap>

    <insert id="insert" parameterType="com.example.trade.domain.TradeEvent">
        INSERT IGNORE INTO trade_event (
        TRADE_ID, ACCOUNT_ID, INSTRUMENT_ID, EVENT_TYPE,
        QUANTITY, PRICE, AMOUNT, CURRENCY, STATUS, SOURCE_SYSTEM,
        TRADE_DATE, CREATE_TIME, UPDATE_TIME
        ) VALUES (
        #{tradeId},
        #{accountId},
        #{instrumentId},
        #{eventType},
        #{quantity},
        #{price},
        #{amount},
        #{currency},
        #{status},
        #{sourceSystem},
        #{tradeDate},
        now(),
        now()
        )
    </insert>


    <select id="findByTradeId" resultMap="TradeEventMap">
        SELECT
        TRADE_ID, ACCOUNT_ID, INSTRUMENT_ID, EVENT_TYPE,
        QUANTITY, PRICE, AMOUNT, CURRENCY, STATUS, SOURCE_SYSTEM,
        TRADE_DATE, CREATE_TIME, UPDATE_TIME
        FROM trade_event WHERE TRADE_ID = #{tradeId}
    </select>

    <select id="findByInstrumentId" resultMap="TradeEventMap">
        SELECT
        TRADE_ID, ACCOUNT_ID, INSTRUMENT_ID, EVENT_TYPE,
        QUANTITY, PRICE, AMOUNT, CURRENCY, STATUS, SOURCE_SYSTEM,
        TRADE_DATE, CREATE_TIME, UPDATE_TIME
        FROM trade_event WHERE INSTRUMENT_ID = #{instrumentId}
    </select>

    <select id="findByAccountId" resultMap="TradeEventMap">
        SELECT
        TRADE_ID, ACCOUNT_ID, INSTRUMENT_ID, EVENT_TYPE,
        QUANTITY, PRICE, AMOUNT, CURRENCY, STATUS, SOURCE_SYSTEM,
        TRADE_DATE, CREATE_TIME, UPDATE_TIME
        FROM trade_event WHERE ACCOUNT_ID = #{accountId}
    </select>

    <update id="updateStatus">
        UPDATE trade_event
        SET
        status = #{status},
        version = version + 1,
        update_time = NOW()
        WHERE trade_id = #{tradeId}
        AND version = #{version}
    </update>

</mapper>
